<div class="profile-container">
    <div class="container">
        <div class="profile-layout">
            <!-- Main Profile Content -->
            <div class="profile-main">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar-wrapper">
                            <img src="<%= profile.profile_pic_url_hd || profile.profile_pic_url || '/images/default-avatar.jpg' %>" 
                                 alt="<%= profile.username %>" 
                                 class="profile-avatar-large">
                            <% if (profile.is_verified) { %>
                            <span class="verified-badge-large">‚úì</span>
                            <% } %>
                        </div>
                        
                        <!-- Stories Preview -->
                        <% if (stories && stories.stories && stories.stories.length > 0) { %>
                        <div class="stories-ring active">
                            <a href="/stories/<%= username %>" class="stories-link">
                                <span class="stories-count"><%= stories.stories.length %></span>
                                <span class="stories-label">Stories</span>
                            </a>
                        </div>
                        <% } else { %>
                        <div class="stories-ring inactive">
                            <span class="stories-count">0</span>
                            <span class="stories-label">Stories</span>
                        </div>
                        <% } %>
                    </div>
                    
                    <div class="profile-info-section">
                        <div class="profile-title">
                            <h1 class="profile-username">@<%= profile.username %></h1>
                            <% if (profile.full_name && profile.full_name !== profile.username) { %>
                            <h2 class="profile-fullname"><%= profile.full_name %></h2>
                            <% } %>
                        </div>
                        
                        <!-- Profile Stats -->
                        <div class="profile-stats">
                            <div class="stat">
                                <span class="stat-number"><%= seo.formatCount(profile.posts_count) %></span>
                                <span class="stat-label">Posts</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number"><%= seo.formatCount(profile.followers_count) %></span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number"><%= seo.formatCount(profile.following_count) %></span>
                                <span class="stat-label">Following</span>
                            </div>
                        </div>
                        
                        <!-- Biography -->
                        <% if (profile.biography) { %>
                        <div class="profile-bio">
                            <p><%= profile.biography %></p>
                        </div>
                        <% } %>
                        
                        <!-- External URL -->
                        <% if (profile.external_url) { %>
                        <div class="profile-website">
                            <a href="<%= profile.external_url %>" target="_blank" rel="noopener" class="website-link">
                                üîó <%= profile.external_url.replace(/^https?:\/\//, '') %>
                            </a>
                        </div>
                        <% } %>
                        
                        <!-- Action Buttons -->
                        <div class="profile-actions">
                            <% if (stories && stories.stories && stories.stories.length > 0) { %>
                            <a href="/stories/<%= username %>" class="btn btn-primary">
                                üì∏ View Stories (<%= stories.stories.length %>)
                            </a>
                            <% } else { %>
                            <button class="btn btn-disabled" disabled>
                                üì∏ No Active Stories
                            </button>
                            <% } %>
                            
                            <a href="https://instagram.com/<%= username %>/" target="_blank" rel="noopener" class="btn btn-outline">
                                üì± View on Instagram
                            </a>
                            
                            <% if (profile.is_private) { %>
                            <div class="privacy-notice">
                                üîí This account is private
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <!-- Adsterra Native Banner - Mid Content -->
                <div class="ad-slot ad-native-mid" style="margin: 20px 0;">
                    <script async="async" data-cfasync="false" src="https://pl28773008.effectivegatecpm.com/7b466dd839b40ecfeb07def8c857f3b2/invoke.js"></script>
                    <div id="container-7b466dd839b40ecfeb07def8c857f3b2"></div>
                </div>

                <!-- Posts Section -->
                <% if (profile.recent_posts && profile.recent_posts.length > 0) { %>
                <div class="posts-section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Posts</h3>
                        <p class="section-subtitle"><%= profile.posts_count %> total posts</p>
                    </div>
                    
                    <div class="posts-grid">
                        <% profile.recent_posts.forEach((post, index) => { %>
                        <div class="post-item" onclick="openPost(<%= index %>)" style="cursor:pointer;">
                                <div class="post-media">
                                    <img src="<%= post.thumbnail_url || post.display_url %>" 
                                         alt="Post by <%= username %>" 
                                         loading="lazy">
                                    
                                    <!-- Post Type Indicator -->
                                    <% if (post.is_video) { %>
                                    <div class="post-type-badge video">
                                        <span class="icon">‚ñ∂Ô∏è</span>
                                    </div>
                                    <% } %>
                                    
                                    <!-- Post Overlay -->
                                    <div class="post-overlay">
                                        <div class="post-stats">
                                            <span class="stat">
                                                ‚ù§Ô∏è <%= seo.formatCount(post.likes_count) %>
                                            </span>
                                            <span class="stat">
                                                üí¨ <%= seo.formatCount(post.comments_count) %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        
                        <!-- In-feed Ad every 4 posts -->
                        <% if (config.ADS.ENABLE_ADS && (index + 1) % 4 === 0 && index < profile.recent_posts.length - 1) { %>
                        <div class="ad-slot ad-posts-infeed" data-ad-slot="<%= config.ADS.GOOGLE_ADSENSE_SLOT_INFEED %>">
                            <div class="ad-label">Advertisement</div>
                            <ins class="adsbygoogle"
                                 style="display:block;width:100%;height:250px"
                                 data-ad-client="<%= config.ADS.GOOGLE_ADSENSE_CLIENT %>"
                                 data-ad-slot="<%= config.ADS.GOOGLE_ADSENSE_SLOT_INFEED %>"></ins>
                        </div>
                        <% } %>
                        <% }) %>
                    </div>
                    
                    <!-- Load More Posts -->
                    <% if (profile.posts_count > profile.recent_posts.length) { %>
                    <div class="load-more-section">
                        <p class="load-more-info">
                            Showing <%= profile.recent_posts.length %> of <%= profile.posts_count %> posts
                        </p>
                        <button class="btn btn-outline" onclick="loadMorePosts('<%= username %>')">
                            Load More Posts
                        </button>
                    </div>
                    <% } %>
                </div>
                <% } else if (profile.posts_count === 0) { %>
                <div class="no-posts-section">
                    <div class="empty-state">
                        <div class="empty-icon">üì∑</div>
                        <h3>No Posts Yet</h3>
                        <p>@<%= username %> hasn't shared any posts yet.</p>
                    </div>
                </div>
                <% } else { %>
                <div class="posts-unavailable-section">
                    <div class="empty-state">
                        <div class="empty-icon">üîí</div>
                        <h3>Posts Unavailable</h3>
                        <p>Posts for this account are currently unavailable. This may be due to privacy settings or temporary restrictions.</p>
                    </div>
                </div>
                <% } %>
            </div>
            
            <!-- Sidebar -->
            <div class="profile-sidebar">
                <!-- Sidebar Ad -->
                <% if (config.ADS.ENABLE_ADS) { %>
                <div class="ad-slot ad-sidebar" data-ad-slot="<%= config.ADS.GOOGLE_ADSENSE_SLOT_SIDEBAR %>">
                    <div class="ad-label">Advertisement</div>
                    <ins class="adsbygoogle"
                         style="display:inline-block;width:300px;height:250px"
                         data-ad-client="<%= config.ADS.GOOGLE_ADSENSE_CLIENT %>"
                         data-ad-slot="<%= config.ADS.GOOGLE_ADSENSE_SLOT_SIDEBAR %>"></ins>
                </div>
                <% } %>
                
                <!-- Profile Quick Actions -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">Quick Actions</h4>
                    <div class="quick-actions">
                        <a href="/stories/<%= username %>" class="action-btn">
                            üì∏ View Stories
                        </a>
                        <button onclick="downloadProfilePicture('<%= profile.profile_pic_url_hd || profile.profile_pic_url %>', '<%= username %>')" class="action-btn">
                            üì• Download Profile Picture
                        </button>
                        <button onclick="shareProfile('<%= username %>')" class="action-btn">
                            üì§ Share Profile
                        </button>
                    </div>
                </div>
                
                <!-- Related Profiles -->
                <% if (relatedProfiles && relatedProfiles.length > 0) { %>
                <div class="sidebar-section">
                    <h4 class="sidebar-title">Trending Profiles</h4>
                    <div class="related-profiles">
                        <% relatedProfiles.forEach(item => { %>
                        <div class="related-profile">
                            <a href="/profile/<%= item.username %>" class="related-link">
                                <img src="<%= item.profile?.profile_pic_url || '/images/default-avatar.jpg' %>" 
                                     alt="<%= item.username %>" 
                                     class="related-avatar">
                                <div class="related-info">
                                    <div class="related-username">@<%= item.username %></div>
                                    <% if (item.profile?.full_name) { %>
                                    <div class="related-fullname"><%= item.profile.full_name %></div>
                                    <% } %>
                                    <% if (item.profile?.followers_count) { %>
                                    <div class="related-followers">
                                        <%= seo.formatCount(item.profile.followers_count) %> followers
                                    </div>
                                    <% } %>
                                </div>
                            </a>
                        </div>
                        <% }) %>
                    </div>
                </div>
                <% } %>
                
                <!-- Profile Information -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">Profile Information</h4>
                    <div class="profile-metadata">
                        <div class="metadata-item">
                            <span class="metadata-label">Username:</span>
                            <span class="metadata-value">@<%= profile.username %></span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Verification:</span>
                            <span class="metadata-value">
                                <% if (profile.is_verified) { %>
                                ‚úÖ Verified
                                <% } else { %>
                                ‚ùå Not Verified
                                <% } %>
                            </span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Privacy:</span>
                            <span class="metadata-value">
                                <% if (profile.is_private) { %>
                                üîí Private Account
                                <% } else { %>
                                üåç Public Account
                                <% } %>
                            </span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Profile ID:</span>
                            <span class="metadata-value"><%= profile.id %></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Actions Script -->
<script>
function downloadProfilePicture(url, username) {
    const link = document.createElement('a');
    link.href = url;
    link.download = `${username}_profile_picture.jpg`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function shareProfile(username) {
    const url = window.location.href;
    const text = `Check out @${username} on InstaViewer - Anonymous Instagram Profile Viewer`;
    
    if (navigator.share) {
        navigator.share({
            title: text,
            url: url
        });
    } else {
        // Fallback to copy URL
        navigator.clipboard.writeText(url).then(() => {
            alert('Profile URL copied to clipboard!');
        });
    }
}

function loadMorePosts(username) {
    // This would typically make an AJAX request to load more posts
    // For now, redirect to a posts page
    window.location.href = `/profile/${username}/posts`;
}
</script>

<!-- Initialize ads -->
<!-- Post Lightbox Modal -->
<div id="postModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <button onclick="closePost()" style="position:fixed;top:16px;right:16px;z-index:10001;background:none;border:none;color:white;font-size:32px;cursor:pointer;padding:8px;">‚úï</button>
  <button id="prevPost" onclick="navPost(-1)" style="position:fixed;left:8px;top:50%;transform:translateY(-50%);z-index:10001;background:rgba(255,255,255,0.15);border:none;color:white;font-size:28px;cursor:pointer;padding:12px 16px;border-radius:50%;">‚Äπ</button>
  <button id="nextPost" onclick="navPost(1)" style="position:fixed;right:8px;top:50%;transform:translateY(-50%);z-index:10001;background:rgba(255,255,255,0.15);border:none;color:white;font-size:28px;cursor:pointer;padding:12px 16px;border-radius:50%;">‚Ä∫</button>
  <div id="postContent" style="max-width:600px;margin:60px auto;padding:16px;"></div>
</div>

<script>
const posts = <%- JSON.stringify((profile.recent_posts || []).map(p => ({
  display_url: p.display_url,
  thumbnail_url: p.thumbnail_url,
  is_video: p.is_video,
  likes_count: p.likes_count,
  comments_count: p.comments_count,
  caption: p.caption || '',
  shortcode: p.shortcode,
  timestamp: p.timestamp
}))) %>;

let currentPostIdx = -1;

function openPost(idx) {
  currentPostIdx = idx;
  renderPost(idx);
  document.getElementById('postModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closePost() {
  document.getElementById('postModal').style.display = 'none';
  document.body.style.overflow = '';
  currentPostIdx = -1;
}

function navPost(dir) {
  const next = currentPostIdx + dir;
  if (next >= 0 && next < posts.length) {
    currentPostIdx = next;
    renderPost(next);
  }
}

function renderPost(idx) {
  const p = posts[idx];
  if (!p) return;
  const date = new Date(p.timestamp * 1000).toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
  const caption = p.caption.length > 300 ? p.caption.slice(0, 300) + '...' : p.caption;
  
  document.getElementById('postContent').innerHTML = `
    <div style="background:#1a1a1a;border-radius:12px;overflow:hidden;">
      <div style="padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #333;">
        <img src="${'<%= profile.profile_pic_url %>'}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
        <div>
          <div style="color:white;font-weight:600;font-size:14px;">@<%= username %></div>
          <div style="color:#999;font-size:12px;">${date}</div>
        </div>
      </div>
      <div style="position:relative;width:100%;background:#000;">
        <img src="${p.display_url}" alt="Post" style="width:100%;display:block;" onerror="this.src='${p.thumbnail_url}'">
      </div>
      <div style="padding:14px 16px;">
        <div style="display:flex;gap:16px;margin-bottom:10px;">
          <span style="color:white;">‚ù§Ô∏è ${formatNum(p.likes_count)}</span>
          <span style="color:white;">üí¨ ${formatNum(p.comments_count)}</span>
        </div>
        ${caption ? `<p style="color:#ddd;font-size:14px;line-height:1.5;margin:0;">${escHtml(caption)}</p>` : ''}
        <div style="margin-top:12px;display:flex;gap:8px;">
          <a href="${p.display_url}" download target="_blank" style="flex:1;text-align:center;padding:10px;background:linear-gradient(135deg,#833AB4,#E1306C);color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;">üì• Download</a>
        </div>
      </div>
    </div>
    <div style="text-align:center;color:#666;font-size:13px;margin-top:12px;">${idx + 1} / ${posts.length}</div>
  `;
}

function formatNum(n) {
  if (!n) return '0';
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return n.toString();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Keyboard nav
document.addEventListener('keydown', e => {
  if (currentPostIdx < 0) return;
  if (e.key === 'Escape') closePost();
  if (e.key === 'ArrowLeft') navPost(-1);
  if (e.key === 'ArrowRight') navPost(1);
});

// Click outside to close
document.getElementById('postModal').addEventListener('click', e => {
  if (e.target.id === 'postModal') closePost();
});

// Swipe support
let touchX = 0;
document.getElementById('postModal').addEventListener('touchstart', e => { touchX = e.touches[0].clientX; });
document.getElementById('postModal').addEventListener('touchend', e => {
  const diff = touchX - e.changedTouches[0].clientX;
  if (Math.abs(diff) > 50) navPost(diff > 0 ? 1 : -1);
});
</script>